# RAG System - Cursor IDE Rules

## Project Overview
This is a local RAG (Retrieval-Augmented Generation) system with a Flask backend and Angular frontend. All processing happens locally using Ollama for LLM and embeddings.

## Technology Stack

### Backend
- **Python 3.8+** with Flask 3.0+
- **LangChain** for RAG chains and document processing
- **ChromaDB** for vector storage
- **Ollama** for local LLM and embeddings
- **Flask-CORS** for cross-origin requests
- **python-dotenv** for environment configuration

### Frontend
- **Angular 19** with standalone components
- **TypeScript 5.7+** with strict mode enabled
- **Tailwind CSS** for styling
- **RxJS** for reactive programming
- **Signals** for state management (Angular signals)

## Code Style & Standards

### Python Backend
- Follow PEP 8 style guide
- Use type hints where possible
- Use pathlib.Path for file operations
- Use logging module (via utils.setup_logging())
- Environment variables via os.getenv() with defaults
- Error handling: catch specific exceptions, log errors, return appropriate HTTP status codes
- Use docstrings for all functions and classes
- Import organization: standard library, third-party, local imports

### Angular Frontend
- Use standalone components (no NgModules)
- Use Angular signals for state management
- Use dependency injection with inject() function
- Follow Angular style guide
- Use Tailwind CSS utility classes (avoid custom CSS when possible)
- Use SCSS for component-specific styles
- TypeScript strict mode enabled - avoid `any` types
- Use RxJS operators properly (pipe, map, catchError, etc.)
- Services extend ApiService base class
- State management via signal-based state services

## Architecture Patterns

### Backend API Structure
- Flask routes in `src/app.py`
- Business logic in separate modules (embed.py, query.py, etc.)
- Authentication via decorators: `@requires_auth`, `@requires_write_auth`
- Session management for user authentication
- Error responses: `{"error": "message"}` with appropriate status codes
- Success responses: `{"message": "..."}` or data objects

### Frontend Architecture
- Feature-based folder structure
- Core services in `web-ui/src/app/core/services/`
- State management in `web-ui/src/app/core/state/`
- Models in `web-ui/src/app/core/models/`
- HTTP interceptors for error handling, loading, API keys
- Guards for route protection
- Components are standalone with explicit imports

## File Organization

### Backend (`src/`)
- `app.py` - Flask API server and routes
- `embed.py` - Document embedding logic
- `query.py` - Query processing and RAG chains
- `get_vector_db.py` - ChromaDB initialization
- `auth.py` - Authentication and authorization
- `settings.py` - Settings storage and retrieval
- `llm_providers.py` - LLM provider factory and implementations
- `confluence.py` - Confluence integration
- `cache.py` - Query result caching
- `query_history.py` - Query history management
- `monitoring.py` - Monitoring and analytics
- `utils.py` - Utility functions and logging setup

### Frontend (`web-ui/src/app/`)
- `features/` - Feature modules (query, admin, auth)
- `core/` - Core services, state, models, guards, interceptors
- `layout/` - Layout components (header, navigation, footer)
- `shared/` - Shared components

## Design System (DESIGNO)

### Colors
- **Primary**: Orange (#f97316) - use `primary-500`, `primary-600`, etc.
- **Background**: Light gray (#F8FAFC) - use `background-50`, `background-100`
- **Surface**: Light gray (#F5F7FA) - use `surface-50`, `surface-100`, `surface-200`
- **Status**: 
  - Success: `#10b981` (status-success)
  - Progress: `#3b82f6` (status-progress)
  - Pending: `#ef4444` (status-pending)

### UI Patterns
- Cards: `bg-white` with `border border-surface-200`
- Buttons: Primary buttons use `bg-primary-500 text-white`, secondary use `bg-white text-primary-600 border border-primary-600`
- Active navigation: `bg-primary-500 text-white`
- Tables: Headers `bg-surface-100`, body `bg-white`
- Forms: Inputs use `border-surface-200`

## Common Patterns

### Adding a New API Endpoint
1. Add route in `src/app.py`
2. Add authentication decorator if needed
3. Validate input parameters
4. Call business logic from appropriate module
5. Return JSON response with appropriate status code
6. Log errors using logger

### Adding a New Frontend Feature
1. Create component in appropriate feature folder
2. Add route in `web-ui/src/app/app.routes.ts`
3. Create service method in `core/services/` if needed
4. Add state management if needed in `core/state/`
5. Update navigation if needed
6. Follow DESIGNO design system

### Error Handling
- Backend: Use try/except, log errors, return JSON error responses
- Frontend: Use error interceptor, display user-friendly messages via notification service
- Always provide meaningful error messages

### Environment Variables
- All configuration via `.env` file (use `.env.example` as template)
- Use `os.getenv()` with sensible defaults
- Document all variables in `.env.example`

## Testing
- Backend: pytest with coverage
- Frontend: Jasmine/Karma (unit tests needed)
- Test files: `tests/` for backend, `*.spec.ts` for frontend

## Security
- Validate all user inputs
- Use pathlib for safe file paths
- Sanitize HTML content (use bleach library)
- Rate limiting on API endpoints (to be implemented)
- Encrypt sensitive data (passwords - to be implemented)
- Session security: HTTPOnly, SameSite cookies

## Docker
- Multi-stage builds for optimization
- Use environment variables for configuration
- Health checks on all services
- Volume mounts for persistent data

## Git Workflow
- Use meaningful commit messages
- Follow conventional commits if possible
- Pre-commit hooks for linting (to be implemented for frontend)

## Important Notes
- Never commit `.env` file
- Never commit `chroma/` directory (vector database)
- Never commit `node_modules/` or `venv/`
- Always use relative imports in Python modules (`.embed` not `embed`)
- Use signals for reactive state in Angular
- Keep components small and focused
- Use services for business logic, not components

