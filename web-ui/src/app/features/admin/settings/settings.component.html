<div class="max-w-4xl mx-auto space-y-6">
  <h1 class="text-3xl font-bold text-gray-900">Settings</h1>
  
  <!-- Tab Navigation -->
  <div class="border-b border-gray-200 mb-6">
    <nav class="flex space-x-8" aria-label="Tabs">
      @for (tab of tabs; track tab.id) {
        <button
          type="button"
          (click)="setActiveTab(tab.id)"
          [class.border-primary-600]="activeTab() === tab.id"
          [class.text-primary-600]="activeTab() === tab.id"
          [class.border-transparent]="activeTab() !== tab.id"
          [class.text-gray-500]="activeTab() !== tab.id"
          [class.hover:text-gray-700]="activeTab() !== tab.id"
          [class.hover:border-gray-300]="activeTab() !== tab.id"
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2"
        >
          @if (tab.icon === 'settings') {
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          }
          @if (tab.icon === 'cloud') {
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
            </svg>
          }
          @if (tab.icon === 'sparkles') {
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
          }
          <span>{{ tab.label }}</span>
        </button>
      }
    </nav>
  </div>
  
  <!-- System Settings Section -->
  @if (activeTab() === 'system') {
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
      <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
      </svg>
      <span>System Settings</span>
    </h2>

    <!-- System Settings Messages -->
    @if (systemError() && systemError().trim()) {
      <div class="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
        {{ systemError() }}
      </div>
    }
    @if (systemSuccess()) {
      <div class="mb-4 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg flex items-center">
        <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>System settings saved successfully</span>
      </div>
    }

    <form (ngSubmit)="saveSystemSettings()" class="space-y-4">
      <div>
        <label for="system-name" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
          <span>System Name</span>
          <app-help-icon [helpText]="getHelpText('system', 'systemName')"></app-help-icon>
        </label>
        <input
          id="system-name"
          type="text"
          [(ngModel)]="systemSettings().systemName"
          name="systemName"
          required
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500"
          placeholder="Enter system name"
        />
        <p class="mt-1 text-xs text-gray-500">
          This name will be displayed throughout the application (header, footer, login page, etc.)
        </p>
      </div>

      <div>
        <button
          type="submit"
          [disabled]="systemLoading() || !systemSettings().systemName.trim()"
          class="flex items-center gap-2 px-6 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          @if (systemLoading()) {
            <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Saving...</span>
          } @else {
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Save System Settings</span>
          }
        </button>
      </div>
    </form>
  </div>
  }

  <!-- Confluence Integration Section -->
  @if (activeTab() === 'confluence') {
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
      <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
      </svg>
      <span>Confluence Integration</span>
    </h2>
    
    <!-- Messages -->
    @if (error()) {
      <div class="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
        {{ error() }}
      </div>
    }
    @if (success()) {
      <div class="mb-4 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">
        {{ success() }}
      </div>
    }
    @if (testResult()) {
      <div class="mb-4 bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg">
        <strong>Test Result:</strong> {{ testResult()!.message }}
      </div>
    }

    <form class="space-y-6" (submit)="$event.preventDefault()">
      <!-- Connection Settings -->
      <div class="space-y-4">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
          </svg>
          <span>Connection Settings</span>
        </h3>
        
        <!-- Confluence URL -->
        <div>
          <label for="confluence-url" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
            </svg>
            <span>Confluence URL *</span>
            <app-help-icon [helpText]="getHelpText('confluence', 'url')"></app-help-icon>
          </label>
          <input
            id="confluence-url"
            type="url"
            [(ngModel)]="confluenceSettings().url"
            name="confluenceUrl"
            required
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500"
            placeholder="https://your-domain.atlassian.net or https://confluence.example.com"
          />
          <p class="mt-1 text-xs text-gray-500">Enter your Confluence instance URL</p>
        </div>

        <!-- Instance Type -->
        <div>
          <label for="instance-type" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
            </svg>
            <span>Instance Type *</span>
            <app-help-icon [helpText]="getHelpText('confluence', 'instanceType')"></app-help-icon>
          </label>
          <select
            id="instance-type"
            [(ngModel)]="confluenceSettings().instanceType"
            name="instanceType"
            required
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500"
          >
            <option value="cloud">Confluence Cloud</option>
            <option value="server">Confluence Server/Data Center</option>
          </select>
        </div>

        <!-- API Token (for Cloud or Server with token) -->
        <div>
          <label for="api-token" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
            </svg>
            <span>API Token</span>
            <app-help-icon [helpText]="getHelpText('confluence', 'apiToken')"></app-help-icon>
          </label>
          <input
            id="api-token"
            type="password"
            [(ngModel)]="confluenceSettings().apiToken"
            name="apiToken"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500"
            placeholder="Enter API token"
          />
          <p class="mt-1 text-xs text-gray-500">
            For Cloud: Get from <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank" class="text-primary-600 hover:underline">Atlassian Account Settings</a>
          </p>
        </div>

        <!-- Username/Password (for Server or Cloud alternative) -->
        @if (confluenceSettings().instanceType === 'server' || !confluenceSettings().apiToken) {
          <div class="space-y-4">
            <div>
              <label for="username" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span>Username</span>
                <app-help-icon [helpText]="getHelpText('confluence', 'username')"></app-help-icon>
              </label>
              <input
                id="username"
                type="text"
                [(ngModel)]="confluenceSettings().username"
                name="username"
                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500"
                placeholder="Enter username"
              />
            </div>
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                <span>Password</span>
                <app-help-icon [helpText]="getHelpText('confluence', 'password')"></app-help-icon>
              </label>
              <input
                id="password"
                type="password"
                [(ngModel)]="confluenceSettings().password"
                name="password"
                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500"
                placeholder="Enter password or API token"
              />
              <p class="mt-1 text-xs text-gray-500">
                For Cloud: Use your API token as password. For Server: Use your account password or Personal Access Token.
              </p>
            </div>
          </div>
        }

        <!-- Test Connection Button -->
        <div>
          <button
            type="button"
            (click)="testConnection()"
            [disabled]="testLoading() || !confluenceSettings().url"
            class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            @if (testLoading()) {
              <span class="flex items-center">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Testing...
              </span>
            } @else {
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Test Connection
              </span>
            }
          </button>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-3 border-t pt-6">
        <button
          type="button"
          (click)="saveSettings()"
          [disabled]="loading() || !confluenceSettings().url"
          class="flex-1 px-6 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          @if (loading()) {
            <span class="flex items-center justify-center">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Saving...
            </span>
          } @else {
            <span class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Save Settings
            </span>
          }
        </button>
      </div>
    </form>
  </div>
  }

  <!-- LLM & Embedding Providers Section -->
  @if (activeTab() === 'llm-providers') {
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
      <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
      </svg>
      <span>LLM & Embedding Providers</span>
    </h2>

    <!-- LLM Provider Messages (for save/load operations) -->
    @if (llmError() && llmError().trim()) {
      <div class="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
        {{ llmError() }}
      </div>
    }
    @if (llmSuccess()) {
      <div class="mb-4 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg flex items-center">
        <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>{{ llmSuccess() }}</span>
      </div>
    }

    <!-- LLM Providers -->
    <div class="space-y-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
        <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
        </svg>
        <span>LLM Providers (Text Generation)</span>
      </h3>

      @if (getLLMProviderKeys().length === 0) {
        <p class="text-sm text-gray-500 mb-4">No LLM providers configured. Add a provider below to get started.</p>
      }

      @for (providerKey of getLLMProviderKeys(); track providerKey) {
        @let provider = llmProviders().llmProviders[providerKey];
        <div class="border border-gray-200 rounded-lg p-4 space-y-4">
          <!-- Per-provider test messages -->
          @if (getProviderTestError(providerKey)) {
            <div class="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded text-sm">
              {{ getProviderTestError(providerKey) }}
            </div>
          }
          @if (getProviderTestSuccess(providerKey)) {
            <div class="bg-green-50 border border-green-200 text-green-700 px-3 py-2 rounded text-sm flex items-center">
              <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>{{ getProviderTestSuccess(providerKey) }}</span>
            </div>
          }
          
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <input
                type="checkbox"
                [(ngModel)]="provider.enabled"
                [name]="'llm-enabled-' + providerKey"
                class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500"
              />
              <label class="font-medium text-gray-700">{{ getProviderDisplayName(provider.type) }}</label>
              @if (provider.isActive) {
                <span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded">Active</span>
              }
            </div>
            <div class="flex items-center gap-2">
              <button
                type="button"
                (click)="testLLMProvider(providerKey, 'llm')"
                [disabled]="isProviderTestLoading(providerKey, 'llm')"
                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
              >
                @if (isProviderTestLoading(providerKey, 'llm')) {
                  <span class="flex items-center">
                    <svg class="animate-spin h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Testing...
                  </span>
                } @else {
                  <span class="flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Test Connection
                  </span>
                }
              </button>
              <button
                type="button"
                (click)="setActiveLLMProvider(providerKey)"
                [disabled]="!provider.enabled || provider.isActive"
                class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
              >
                Set Active
              </button>
              <button
                type="button"
                (click)="removeLLMProvider('llm', providerKey)"
                class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700"
              >
                Remove
              </button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <span>Model</span>
                <app-help-icon [helpText]="getHelpText('llmProviders', 'model')"></app-help-icon>
              </label>
              <input
                type="text"
                [(ngModel)]="provider.model"
                [name]="'llm-model-' + providerKey"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500"
                placeholder="Model name"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <span>Temperature</span>
                <app-help-icon [helpText]="getHelpText('llmProviders', 'temperature')"></app-help-icon>
              </label>
              <input
                type="number"
                [(ngModel)]="provider.temperature"
                [name]="'llm-temp-' + providerKey"
                min="0"
                max="2"
                step="0.1"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <span>API Key</span>
                <app-help-icon [helpText]="getHelpText('llmProviders', 'apiKey')"></app-help-icon>
              </label>
              <input
                type="password"
                [(ngModel)]="provider.apiKey"
                [name]="'llm-apikey-' + providerKey"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500"
                placeholder="Enter API key"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <span>Base URL</span>
                <app-help-icon [helpText]="getHelpText('llmProviders', 'baseUrl')"></app-help-icon>
              </label>
              <input
                type="text"
                [(ngModel)]="provider.baseUrl"
                [name]="'llm-baseurl-' + providerKey"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500"
                placeholder="API base URL (optional)"
              />
            </div>
          </div>
        </div>
      }

      <div class="flex items-center gap-2">
        <select
          [ngModel]="newProviderType()"
          (ngModelChange)="newProviderType.set($event)"
          class="px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500"
        >
          <option value="">Select provider type...</option>
          @for (type of availableProviderTypes; track type) {
            <option [value]="type">{{ getProviderDisplayName(type) }}</option>
          }
        </select>
        <button
          type="button"
          (click)="addLLMProviderAndClear('llm')"
          [disabled]="!newProviderType()"
          class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 disabled:opacity-50"
        >
          Add LLM Provider
        </button>
      </div>
    </div>

    <!-- Embedding Providers -->
    <div class="space-y-6">
      <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
        <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
        </svg>
        <span>Embedding Providers</span>
      </h3>

      @if (getEmbeddingProviderKeys().length === 0) {
        <p class="text-sm text-gray-500 mb-4">No embedding providers configured. Add a provider below to get started.</p>
      }

      @for (providerKey of getEmbeddingProviderKeys(); track providerKey) {
        @let provider = llmProviders().embeddingProviders[providerKey];
        <div class="border border-gray-200 rounded-lg p-4 space-y-4">
          <!-- Per-provider test messages -->
          @if (getProviderTestError(providerKey)) {
            <div class="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded text-sm">
              {{ getProviderTestError(providerKey) }}
            </div>
          }
          @if (getProviderTestSuccess(providerKey)) {
            <div class="bg-green-50 border border-green-200 text-green-700 px-3 py-2 rounded text-sm flex items-center">
              <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>{{ getProviderTestSuccess(providerKey) }}</span>
            </div>
          }
          
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <input
                type="checkbox"
                [(ngModel)]="provider.enabled"
                [name]="'emb-enabled-' + providerKey"
                class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500"
              />
              <label class="font-medium text-gray-700">{{ getProviderDisplayName(provider.type) }}</label>
              @if (provider.isActive) {
                <span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded">Active</span>
              }
            </div>
            <div class="flex items-center gap-2">
              <button
                type="button"
                (click)="testLLMProvider(providerKey, 'embedding')"
                [disabled]="isProviderTestLoading(providerKey, 'embedding')"
                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
              >
                @if (isProviderTestLoading(providerKey, 'embedding')) {
                  <span class="flex items-center">
                    <svg class="animate-spin h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Testing...
                  </span>
                } @else {
                  <span class="flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Test Connection
                  </span>
                }
              </button>
              <button
                type="button"
                (click)="setActiveEmbeddingProvider(providerKey)"
                [disabled]="!provider.enabled || provider.isActive"
                class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
              >
                Set Active
              </button>
              <button
                type="button"
                (click)="removeLLMProvider('embedding', providerKey)"
                class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700"
              >
                Remove
              </button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <span>Model</span>
                <app-help-icon [helpText]="getHelpText('embeddingProviders', 'model')"></app-help-icon>
              </label>
              <input
                type="text"
                [(ngModel)]="provider.model"
                [name]="'emb-model-' + providerKey"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500"
                placeholder="Model name"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <span>API Key</span>
                <app-help-icon [helpText]="getHelpText('embeddingProviders', 'apiKey')"></app-help-icon>
              </label>
              <input
                type="password"
                [(ngModel)]="provider.apiKey"
                [name]="'emb-apikey-' + providerKey"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500"
                placeholder="Enter API key"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <span>Base URL</span>
                <app-help-icon [helpText]="getHelpText('embeddingProviders', 'baseUrl')"></app-help-icon>
              </label>
              <input
                type="text"
                [(ngModel)]="provider.baseUrl"
                [name]="'emb-baseurl-' + providerKey"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500"
                placeholder="API base URL (optional)"
              />
            </div>
          </div>
        </div>
      }

      <div class="flex items-center gap-2">
        <select
          [ngModel]="newProviderType()"
          (ngModelChange)="newProviderType.set($event)"
          class="px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500"
        >
          <option value="">Select provider type...</option>
          @for (type of availableProviderTypes; track type) {
            <option [value]="type">{{ getProviderDisplayName(type) }}</option>
          }
        </select>
        <button
          type="button"
          (click)="addLLMProviderAndClear('embedding')"
          [disabled]="!newProviderType()"
          class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 disabled:opacity-50"
        >
          Add Embedding Provider
        </button>
      </div>
    </div>

    <!-- Save Button -->
    <div class="mt-6 pt-6 border-t">
      <button
        type="button"
        (click)="saveLLMProviders()"
        [disabled]="llmLoading()"
        class="px-6 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        @if (llmLoading()) {
          <span class="flex items-center">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Saving...
          </span>
        } @else {
          <span class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Save LLM Provider Settings
          </span>
        }
      </button>
    </div>
  </div>
  }
</div>
